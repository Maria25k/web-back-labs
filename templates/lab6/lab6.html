{% extends "base.html" %}

{% block lab %}–õ–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω–∞—è —Ä–∞–±–æ—Ç–∞ 6{% endblock %}

{% block script %}
<script>
function getOfficeList() {
    const url = '/lab6/json-rpc-api/'
    const json = {
        'jsonrpc': '2.0',
        'method': 'info',
        'id': Math.round(Math.random()*1000)
    };
    fetch(url, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(json)
    })
    .then(function(response) {
        return response.json()
    })
    .then(function(data) {
        const office_list = data.result;
        const ul = document.getElementById('office-list');
        const totalCostDiv = document.getElementById('total-cost');
        ul.innerHTML = '';
        
        let totalCost = 0;
        let bookedCount = 0;
        
        for(let i = 0; i < office_list.length; i++) {
            const office = office_list[i];
            const li = document.createElement('li');
            li.className = 'office-item';
            
            // –°–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ–± –æ—Ñ–∏—Å–µ
            const officeInfo = document.createElement('div');
            officeInfo.className = 'office-info';
            
            // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –Ω–æ–º–µ—Ä –æ—Ñ–∏—Å–∞, –∞—Ä–µ–Ω–¥–∞—Ç–æ—Ä–∞ –∏ —Å—Ç–æ–∏–º–æ—Å—Ç—å
            const status = office.tenant ? `–ê—Ä–µ–Ω–¥–æ–≤–∞–Ω: ${office.tenant}` : '–°–≤–æ–±–æ–¥–µ–Ω';
            const statusClass = office.tenant ? 'status-booked' : 'status-free';
            
            officeInfo.innerHTML = `
                <div class="office-number">–û—Ñ–∏—Å ‚Ññ${office.number}</div>
                <div class="office-price">${office.price} —Ä—É–±./–º–µ—Å.</div>
                <div class="office-status ${statusClass}">${status}</div>
            `;
            
            li.appendChild(officeInfo);

            // –ö–Ω–æ–ø–∫–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è (—Ç–æ–ª—å–∫–æ –¥–ª—è —Å–≤–æ–±–æ–¥–Ω—ã—Ö –æ—Ñ–∏—Å–æ–≤)
            if (!office.tenant) {
                const bookingButton = document.createElement('button');
                bookingButton.className = 'btn btn-book';
                bookingButton.innerText = '–ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å';
                bookingButton.onclick = function() { booking(office.number); };
                li.appendChild(bookingButton);
            } else {
                // –ö–Ω–æ–ø–∫–∞ –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏—è (—Ç–æ–ª—å–∫–æ –¥–ª—è –∞—Ä–µ–Ω–¥–æ–≤–∞–Ω–Ω—ã—Ö –æ—Ñ–∏—Å–æ–≤)
                const cancelButton = document.createElement('button');
                cancelButton.className = 'btn btn-cancel';
                cancelButton.innerText = '–û—Å–≤–æ–±–æ–¥–∏—Ç—å';
                cancelButton.onclick = function() { cancellation(office.number); };
                li.appendChild(cancelButton);
                
                // –°—á–∏—Ç–∞–µ–º –æ–±—â—É—é —Å—Ç–æ–∏–º–æ—Å—Ç—å –∞—Ä–µ–Ω–¥–æ–≤–∞–Ω–Ω—ã—Ö –æ—Ñ–∏—Å–æ–≤
                totalCost += office.price;
                bookedCount++;
            }

            ul.appendChild(li);
        }
        
        // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –æ–±—â—É—é —Å—Ç–æ–∏–º–æ—Å—Ç—å
        if (totalCost > 0) {
            totalCostDiv.innerHTML = `
                <div class="total-cost-card">
                    <h3>üí∞ –°–≤–æ–¥–∫–∞ –ø–æ –∞—Ä–µ–Ω–¥–µ</h3>
                    <div class="cost-details">
                        <div>–ê—Ä–µ–Ω–¥–æ–≤–∞–Ω–æ –æ—Ñ–∏—Å–æ–≤: <strong>${bookedCount}</strong></div>
                        <div>–û–±—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å: <strong class="total-amount">${totalCost} —Ä—É–±./–º–µ—Å.</strong></div>
                    </div>
                </div>
            `;
        } else {
            totalCostDiv.innerHTML = '<div class="no-rentals">üè¢ –ù–µ—Ç –∞—Ä–µ–Ω–¥–æ–≤–∞–Ω–Ω—ã—Ö –æ—Ñ–∏—Å–æ–≤</div>';
        }
    });
}

function booking(officeNumber) {  
    const url = '/lab6/json-rpc-api/';  
    const json = {  
        'jsonrpc': '2.0',  
        'method': 'booking',  
        'params': officeNumber,  
        'id': Math.round(Math.random()*1000)  
    };  
    fetch(url, {  
        method: 'POST',  
        headers: {'Content-Type': 'application/json'},  
        body: JSON.stringify(json)  
    })  
    .then(function(response) {  
        return response.json();  
    })  
    .then(function(data) {
        if(data.error) {
            switch(data.error.code) {
                case 1:
                    alert('–í—ã –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ã, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –∞–≤—Ç–æ—Ä–∏–∑–∏—Ä—É–π—Ç–µ—Å—å');
                    break;
                case 2:
                    alert('–û—Ñ–∏—Å —É–∂–µ –∞—Ä–µ–Ω–¥—É–µ—Ç—Å—è');
                    break;
                default:
                    alert('–û—à–∏–±–∫–∞: ' + data.error.message);
            }
        } else {
            getOfficeList();
        }
    });
}

function cancellation(officeNumber) {  
    const url = '/lab6/json-rpc-api/';  
    const json = {  
        'jsonrpc': '2.0',  
        'method': 'cancellation',  
        'params': officeNumber,  
        'id': Math.round(Math.random()*1000)  
    };  
    fetch(url, {  
        method: 'POST',  
        headers: {'Content-Type': 'application/json'},  
        body: JSON.stringify(json)  
    })  
    .then(function(response) {  
        return response.json();  
    })  
    .then(function(data) {
        if(data.error) {
            switch(data.error.code) {
                case 1:
                    alert('–í—ã –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ã, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –∞–≤—Ç–æ—Ä–∏–∑–∏—Ä—É–π—Ç–µ—Å—å');
                    break;
                case 3:
                    alert('–û—Ñ–∏—Å –Ω–µ –∞—Ä–µ–Ω–¥–æ–≤–∞–Ω');
                    break;
                case 4:
                    alert('–í—ã –º–æ–∂–µ—Ç–µ –æ—Å–≤–æ–±–æ–¥–∏—Ç—å —Ç–æ–ª—å–∫–æ —Å–≤–æ–π –æ—Ñ–∏—Å');
                    break;
                default:
                    alert('–û—à–∏–±–∫–∞: ' + data.error.message);
            }
        } else {
            getOfficeList();
        }
    });
}

document.addEventListener('DOMContentLoaded', function() {
    getOfficeList();
});
</script>

<style>
.office-list {
    list-style: none;
    padding: 0;
    max-width: 800px;
    margin: 0 auto;
}

.office-item {
    background: white;
    border: 2px solid #e0e0e0;
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 15px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    transition: all 0.3s ease;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.office-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.office-info {
    flex-grow: 1;
}

.office-number {
    font-size: 1.3em;
    font-weight: bold;
    color: #2c3e50;
    margin-bottom: 5px;
}

.office-price {
    font-size: 1.1em;
    color: #27ae60;
    font-weight: bold;
    margin-bottom: 5px;
}

.office-status {
    font-size: 0.9em;
    padding: 4px 8px;
    border-radius: 6px;
    display: inline-block;
}

.status-free {
    background: #d4edda;
    color: #155724;
}

.status-booked {
    background: #f8d7da;
    color: #721c24;
}

.btn {
    padding: 10px 20px;
    border: none;
    border-radius: 8px;
    font-size: 0.9em;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.3s ease;
    margin-left: 15px;
}

.btn-book {
    background: #ff79b7;
    color: white;
}

.btn-book:hover {
    background: #fffb80;
    transform: scale(1.05);
}

.btn-cancel {
    background: #e74c3c;
    color: white;
}

.btn-cancel:hover {
    background: #c0392b;
    transform: scale(1.05);
}

.total-cost-card {
    background: linear-gradient(135deg, #ff84b5 0%, #ff84b5 100%);
    color: white;
    padding: 25px;
    border-radius: 15px;
    margin-top: 30px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    max-width: 400px;
    margin-left: auto;
    margin-right: auto;
}

.total-cost-card h3 {
    margin-top: 0;
    text-align: center;
    font-size: 1.4em;
}

.cost-details {
    text-align: center;
    font-size: 1.1em;
}

.total-amount {
    font-size: 1.3em;
    color: #f1c40f;
}

.no-rentals {
    text-align: center;
    color: #7f8c8d;
    font-size: 1.1em;
    margin-top: 30px;
    padding: 20px;
    background: #f8f9fa;
    border-radius: 10px;
    border: 2px dashed #bdc3c7;
}

.page-title {
    text-align: center;
    color: #2c3e50;
    margin-bottom: 30px;
    font-size: 2.2em;
}

@media (max-width: 768px) {
    .office-item {
        flex-direction: column;
        text-align: center;
        gap: 15px;
    }
    
    .btn {
        margin-left: 0;
        width: 100%;
    }
}
</style>
{% endblock %}

{% block main %}
    <h1 class="page-title">üè¢ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—Ñ–∏—Å–∞–º–∏</h1>
    <ul id="office-list" class="office-list"></ul>
    <div id="total-cost"></div>
{% endblock %}